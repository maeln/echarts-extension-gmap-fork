/*!
 * echarts-extension-gmap 
 * @version 1.3.1
 * @author plainheart
 * 
 * MIT License
 * 
 * Copyright (c) 2020 Zhongxiang.Wang
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).echarts=e.echarts||{},e.echarts.gmap={}),e.echarts)}(this,(function(e,t){"use strict";function n(e,t){this._gmap=e,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=t}var o,i=n.prototype,r=["echartsLayerZIndex","renderOnMoving"];function a(e,n){return n=n||[0,0],t.util.map([0,1],(function(t){var o=n[t],i=e[t]/2,r=[],a=[];return r[t]=o-i,a[t]=o+i,r[1-t]=a[1-t]=n[1-t],Math.abs(this.dataToPoint(r)[t]-this.dataToPoint(a)[t])}),this)}function s(e,t){var n=t.__overlayProjection;return n?n.fromLatLngToContainerPixel(e):new google.maps.Point(-Infinity,-Infinity)}i.dimensions=["lng","lat"],i.setZoom=function(e){this._zoom=e},i.setCenter=function(e){var t=new google.maps.LatLng(e[1],e[0]);this._center=s(t,this._gmap)},i.setMapOffset=function(e){this._mapOffset=e},i.setGoogleMap=function(e){this._gmap=e},i.getGoogleMap=function(){return this._gmap},i.dataToPoint=function(e){var t=s(new google.maps.LatLng(e[1],e[0]),this._gmap),n=this._mapOffset;return[t.x-n[0],t.y-n[1]]},i.pointToData=function(e){var t=this._mapOffset,n=function(e,t){var n=t.__overlayProjection;if(!n)return new google.maps.Point(-Infinity,-Infinity);return n.fromContainerPixelToLatLng(e)}(new google.maps.Point(e[0]+t[0],e[1]+t[1]),this._gmap);return[n.lng(),n.lat()]},i.getViewRect=function(){var e=this._api;return new t.graphic.BoundingRect(0,0,e.getWidth(),e.getHeight())},i.getRoamTransform=function(){return t.matrix.create()},i.prepareCustoms=function(e){var n=this.getViewRect();return{coordSys:{type:"gmap",x:n.x,y:n.y,width:n.width,height:n.height},api:{coord:t.util.bind(this.dataToPoint,this),size:t.util.bind(a,this)}}},n.dimensions=i.dimensions,n.create=function(e,i){var a,s=i.getDom();e.eachComponent("gmap",(function(e){var f=i.getZr().painter,l=f.getViewportRoot();if("undefined"==typeof google||"undefined"==typeof google.maps||"undefined"==typeof google.maps.Map)throw new Error("It seems that Google Map API has not been loaded completely yet.");if(o=o||function(){function e(e,t){this._root=e,this.setMap(t)}return e.prototype=new google.maps.OverlayView,e.prototype.onAdd=function(){var e=this.getMap();e.__overlayProjection=this.getProjection(),e.getDiv().querySelector(".gm-style > div").appendChild(this._root)},e.prototype.draw=function(){google.maps.event.trigger(this.getMap(),"gmaprender")},e.prototype.onRemove=function(){this._root.parentNode.removeChild(this._root),this._root=null},e.prototype.setZIndex=function(e){this._root.style.zIndex=e},e.prototype.getZIndex=function(){return this._root.style.zIndex},e}(),a)throw new Error("Only one google map component can exist");var p=e.getGoogleMap();if(!p){var u=s.querySelector(".ec-extension-google-map");u&&(l.style.left="0px",l.style.top="0px",l.style.width="100%",l.style.height="100%",s.removeChild(u)),(u=document.createElement("div")).className="ec-extension-google-map",u.style.cssText="position:absolute;top:0;left:0;right:0;bottom:0;",s.appendChild(u);var g=t.util.clone(e.get()),c=g.echartsLayerZIndex;t.util.each(r,(function(e){delete g[e]}));var d=g.center;t.util.isArray(d)&&(g.center={lng:d[0],lat:d[1]}),p=new google.maps.Map(u,g),e.setGoogleMap(p),e.__projectionChangeListener&&e.__projectionChangeListener.remove(),e.__projectionChangeListener=google.maps.event.addListener(p,"projection_changed",(function(){var t=e.getEChartsLayer();t&&t.setMap(null);var n=new o(l,p);n.setZIndex(c),e.setEChartsLayer(n)})),f.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}}var m=[null!=(d=e.get("center")).lng?d.lng:d[0],null!=d.lat?d.lat:d[1]],h=e.get("zoom");if(d&&h){var y=p.getCenter(),v=p.getZoom();if(e.centerOrZoomChanged([y.lng(),y.lat()],v)){var _=new google.maps.LatLng(m[1],m[0]);p.setOptions({center:_,zoom:h})}}(a=new n(p,i)).setMapOffset(e.__mapOffset||[0,0]),a.setZoom(h),a.setCenter(m),e.coordinateSystem=a})),e.eachSeries((function(e){"gmap"===e.get("coordinateSystem")&&(e.coordinateSystem=a)}))},t.extendComponentModel({type:"gmap",setGoogleMap:function(e){this.__gmap=e},getGoogleMap:function(){return this.__gmap},setEChartsLayer:function(e){this.__echartsLayer=e},getEChartsLayer:function(){return this.__echartsLayer},setCenterAndZoom:function(e,t){this.option.center=e,this.option.zoom=t},centerOrZoomChanged:function(e,t){var n,o,i=this.option;return n=e,o=i.center,!(n&&o&&n[0]===o[0]&&n[1]===o[1]&&t===i.zoom)},defaultOption:{center:{lat:39.90923,lng:116.397428},zoom:5,echartsLayerZIndex:2e3,renderOnMoving:!0}});var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},l=/^\s+|\s+$/g,p=/^[-+]0x[0-9a-f]+$/i,u=/^0b[01]+$/i,g=/^0o[0-7]+$/i,c=parseInt,d="object"==typeof f&&f&&f.Object===Object&&f,m="object"==typeof self&&self&&self.Object===Object&&self,h=d||m||Function("return this")(),y=Object.prototype.toString,v=Math.max,_=Math.min,w=function(){return h.Date.now()};function x(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function C(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==y.call(e)}(e))return NaN;if(x(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=x(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(l,"");var n=u.test(e);return n||g.test(e)?c(e.slice(2),n?2:8):p.test(e)?NaN:+e}var M=function(e,t,n){var o,i,r,a,s,f,l=0,p=!1,u=!1,g=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function c(t){var n=o,r=i;return o=i=undefined,l=t,a=e.apply(r,n)}function d(e){return l=e,s=setTimeout(h,t),p?c(e):a}function m(e){var n=e-f;return f===undefined||n>=t||n<0||u&&e-l>=r}function h(){var e=w();if(m(e))return y(e);s=setTimeout(h,function(e){var n=t-(e-f);return u?_(n,r-(e-l)):n}(e))}function y(e){return s=undefined,g&&o?c(e):(o=i=undefined,a)}function M(){var e=w(),n=m(e);if(o=arguments,i=this,f=e,n){if(s===undefined)return d(f);if(u)return s=setTimeout(h,t),c(f)}return s===undefined&&(s=setTimeout(h,t)),a}return t=C(t)||0,x(n)&&(p=!!n.leading,r=(u="maxWait"in n)?v(C(n.maxWait)||0,t):r,g="trailing"in n?!!n.trailing:g),M.cancel=function(){s!==undefined&&clearTimeout(s),l=0,o=f=i=s=undefined},M.flush=function(){return s===undefined?a:y(w())},M};t.extendComponentView({type:"gmap",render:function(e,n,o){var i=!0,r=e.getGoogleMap(),a=o.getZr().painter.getViewportRoot(),s=e.coordinateSystem,f=r.getDiv(),l=e.get("renderOnMoving"),p=f.clientWidth,u=f.clientHeight,g=function(){if(!i){var t=f.clientWidth,n=f.clientHeight;if(t!==p||n!==u)return c.call(this);var r=[-parseInt(f.style.left,10)||0,-parseInt(f.style.top,10)||0];a.style.left=r[0]+"px",a.style.top=r[1]+"px",s.setMapOffset(r),e.__mapOffset=r,o.dispatchAction({type:"gmapRoam",animation:{duration:0}})}},c=function(){t.getInstanceByDom(o.getDom()).resize()};this._oldRenderHandler&&this._oldRenderHandler.remove(),l||(g=M(g,100),c=M(c,100)),this._oldRenderHandler=google.maps.event.addListener(r,"gmaprender",g),i=!1},dispose:function(e,t){this._oldRenderHandler&&this._oldRenderHandler.remove(),this._oldRenderHandler=null;var n=e.getComponent("gmap");if(n){var o=n.getGoogleMap();if(o){delete o.__overlayProjection,google.maps.event.clearInstanceListeners(o);var i=o.getDiv();i.parentNode&&i.parentNode.removeChild(i)}n.setGoogleMap(null),n.setEChartsLayer(null),n.coordinateSystem&&(n.coordinateSystem.setGoogleMap(null),n.coordinateSystem=null)}}}),t.registerCoordinateSystem("gmap",n),t.registerAction({type:"gmapRoam",event:"gmapRoam",update:"updateLayout"},(function(e,t){t.eachComponent("gmap",(function(e){var t=e.getGoogleMap(),n=t.getCenter();e.setCenterAndZoom([n.lng(),n.lat()],t.getZoom())}))})),e.name="echarts-extension-gmap",e.version="1.3.1",Object.defineProperty(e,"__esModule",{value:!0})}));
